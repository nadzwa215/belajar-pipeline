name: Advanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]  # ← PASTIKAN ADA 'develop' DI SINI
  pull_request:
    branches: [ main, develop ]  # ← DAN DI SINI JUGA

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: 🛎️ Checkout code
      uses: actions/checkout@v4

    - name: 🔍 Run Tests
      run: |
        echo "🧪 Running tests for branch: ${{ github.ref }}"
        echo "✅ All files present and valid"

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: 🛎️ Checkout code
      uses: actions/checkout@v4

    - name: 🏗️ Build Docker Image
      run: |
        echo "🐳 Building Docker image for branch: ${{ github.ref }}"
        docker build -t belajar-app .
        echo "✅ Docker image built successfully!"

  # DEPLOY BERDASARKAN BRANCH
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'  # ← KHUSUS UNTUK DEVELOP
    steps:
    - name: 🚀 Deploy to Staging (Steven)
      run: |
        echo "========================================"
        echo "🚀 DEPLOYING TO STAGING (STEVEN)"
        echo "========================================"
        echo "🎯 Environment: Staging"
        echo "📱 Display: Steven's Monitor"
        echo "🌐 Branch: develop"
        echo "🕒 Timestamp: $(date)"
        echo "✅ Staging deployment completed!"
        echo "========================================"

  deploy-production:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'  # ← KHUSUS UNTUK MAIN
    steps:
    - name: 🚀 Deploy to Production (Sarah & Jules)
      run: |
        echo "========================================"
        echo "🚀 DEPLOYING TO PRODUCTION (SARAH + JULES)"
        echo "========================================"
        echo "🎯 Environment: Production"
        echo "📱 Displays: Sarah's Monitor + Jules's Show-meter"
        echo "🌐 Branch: main"
        echo "🕒 Timestamp: $(date)"
        echo "✅ Production deployment completed!"
        echo "========================================"