name: Advanced CI/CD Pipeline with Multiple Displays

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # âœ… JOB PERTAMA: TEST
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Run Tests
      run: |
        echo "ðŸ§ª Running tests..."
        test -f index.html && echo "âœ… index.html exists"
        test -f Dockerfile && echo "âœ… Dockerfile exists"

  # âœ… JOB KEDUA: BUILD  
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Build Docker Image
      run: |
        echo "ðŸ³ Building Docker image..."
        docker build -t belajar-app .
        echo "âœ… Docker image built!"

  # âœ… JOB KETIGA: DEPLOY STAGING
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
    - name: ðŸš€ Deploy to Staging
      run: |
        echo "ðŸš€ Deploying to Staging Environment..."
        echo "âœ… Staging deployment completed!"

  # âœ… JOB KEEMPAT: DEPLOY KUBERNETES (BARU)
  deploy-kubernetes:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Setup Kubernetes
      uses: azure/setup-kubectl@v3
      
    - name: ðŸ“ Setup KUBECONFIG
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
        kubectl cluster-info
        echo "âœ… Connected to Rancher Kubernetes!"

    - name: ðŸš€ Deploy to Rancher
      run: |
        echo "ðŸ”§ Deploying to Rancher Kubernetes..."
        kubectl apply -f kubc/first-app.yaml
        kubectl rollout status deployment/steven-display --timeout=180s
        kubectl get pods
        echo "âœ… Successfully deployed to Kubernetes!"